<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown ç¼–è¾‘å™¨</title>
  <style>
    :root {
      --bg-color: #f5f5f5;
      --bg-secondary: #fff;
      --border-color: #e1e4e8;
      --text-color: #24292e;
      --text-secondary: #586069;
      --button-bg: #f6f8fa;
      --button-hover: #e1e4e8;
      --primary-color: #0366d6;
      --danger-color: #d73a49;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --line-number-bg: #fafbfc;
      --line-number-color: #6a737d;
      --quote-bg: #f6f8fa;
      --quote-border: #dfe2e5;
      --disabled-color: #6a737d;
    }

    .theme-dark {
      --bg-color: #0d1117;
      --bg-secondary: #161b22;
      --border-color: #30363d;
      --text-color: #c9d1d9;
      --text-secondary: #8b949e;
      --button-bg: #21262d;
      --button-hover: #30363d;
      --primary-color: #58a6ff;
      --danger-color: #f85149;
      --success-color: #3fb950;
      --warning-color: #d29922;
      --shadow: 0 1px 3px rgba(0,0,0,0.3);
      --line-number-bg: #161b22;
      --line-number-color: #6e7681;
      --quote-bg: #161b22;
      --quote-border: #30363d;
      --disabled-color: #6e7681;
    }

    .theme-green {
      --bg-color: #f0f4e8;
      --bg-secondary: #fefffe;
      --border-color: #c8d3b0;
      --text-color: #2d3e2a;
      --text-secondary: #4a5d47;
      --button-bg: #e8f2dd;
      --button-hover: #d4e6c1;
      --primary-color: #2d8a3e;
      --danger-color: #d4512b;
      --success-color: #28a745;
      --warning-color: #e6a23c;
      --shadow: 0 1px 3px rgba(45, 62, 42, 0.1);
      --line-number-bg: #e8f2dd;
      --line-number-color: #6a8f5e;
      --quote-bg: #e8f2dd;
      --quote-border: #c8d3b0;
      --disabled-color: #6a8f5e;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-color);
      height: 100vh;
      overflow: hidden;
      color: var(--text-color);
      transition: all 0.3s ease;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .toolbar {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      box-shadow: var(--shadow);
      position: relative;
      z-index: 10;
    }

    .toolbar button, .toolbar select {
      background: var(--button-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-color);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .toolbar button:hover, .toolbar select:hover {
      background: var(--button-hover);
    }

    .toolbar button:disabled {
      background: var(--button-bg);
      color: var(--disabled-color);
      cursor: not-allowed;
      opacity: 0.6;
    }

    .toolbar button:disabled:hover {
      background: var(--button-bg);
    }

    .toolbar button.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .toolbar .success-btn {
      background: var(--success-color);
      color: white;
      border-color: var(--success-color);
    }

    .toolbar .success-btn:hover {
      background: color-mix(in srgb, var(--success-color) 80%, black);
    }

    .toolbar .danger-btn {
      background: var(--danger-color);
      color: white;
      border-color: var(--danger-color);
    }

    .toolbar .danger-btn:hover {
      background: color-mix(in srgb, var(--danger-color) 80%, black);
    }

    .divider {
      width: 1px;
      height: 24px;
      background: var(--border-color);
      margin: 0 4px;
    }

    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .editor-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      position: relative;
    }

    .editor-section.locked::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.1);
      z-index: 10;
      pointer-events: none;
    }

    .editor-header {
      background: var(--button-bg);
      border-bottom: 1px solid var(--border-color);
      padding: 8px 16px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .editor-container {
      flex: 1;
      display: flex;
      position: relative;
      overflow: hidden;
    }

    .editor-locked-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.05);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 5;
      flex-direction: column;
      gap: 16px;
    }

    .editor-locked-overlay.show {
      display: flex;
    }

    .locked-message {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      text-align: center;
      border: 1px solid var(--border-color);
    }

    .locked-message h3 {
      margin-bottom: 8px;
      color: var(--text-color);
    }

    .locked-message p {
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .line-numbers {
      background: var(--line-number-bg);
      border-right: 1px solid var(--border-color);
      color: var(--line-number-color);
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      line-height: 1.6;
      min-width: 50px;
      text-align: right;
      user-select: none;
      overflow: hidden;
      position: relative;
      padding: 16px 8px 16px 8px;
    }

    .line-numbers .line-number {
      cursor: pointer;
      padding: 0 4px;
      border-radius: 3px;
      transition: background-color 0.2s;
      height: 22.4px; /* åŒ¹é…ç¼–è¾‘å™¨è¡Œé«˜ */
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .line-numbers .line-number:hover {
      background: var(--button-hover);
    }

    .line-numbers .line-number.active {
      background: var(--primary-color);
      color: white;
    }

    .editor {
      flex: 1;
      border: none;
      outline: none;
      padding: 16px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      line-height: 1.6;
      resize: none;
      background: var(--bg-secondary);
      color: var(--text-color);
      position: relative;
      overflow-y: auto;
    }

    .editor:disabled {
      background: var(--button-bg);
      color: var(--disabled-color);
      cursor: not-allowed;
    }

    .preview-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-secondary);
      transition: all 0.3s ease;
    }

    .preview-section.hidden {
      flex: 0;
      min-width: 0;
      overflow: hidden;
    }

    .preview-header {
      background: var(--button-bg);
      border-bottom: 1px solid var(--border-color);
      padding: 8px 16px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .preview {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: var(--bg-secondary);
    }

    /* æ–‡ä»¶ç®¡ç†é¢æ¿ */
    .file-panel {
      width: 280px;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    .file-panel.hidden {
      width: 0;
      min-width: 0;
      overflow: hidden;
    }

    .file-panel-header {
      background: var(--button-bg);
      border-bottom: 1px solid var(--border-color);
      padding: 8px 16px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .file-panel-controls {
      display: flex;
      gap: 2px;
      align-items: center;
    }

    .file-panel-controls button {
      padding: 4px 6px;
      font-size: 12px;
      border: 1px solid var(--border-color);
      background: var(--button-bg);
      color: var(--text-color);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .file-panel-controls button:hover {
      background: var(--button-hover);
    }

    .current-file-info {
      font-size: 12px;
      color: var(--text-secondary);
      padding: 8px 16px;
      border-bottom: 1px solid var(--border-color);
      background: var(--button-bg);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .current-file-info .file-name {
      color: var(--primary-color);
      font-weight: bold;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .current-file-info .file-name.no-file {
      color: var(--disabled-color);
      font-style: italic;
    }

    .save-status {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
    }

    .save-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .save-indicator.saved {
      background: var(--success-color);
    }

    .save-indicator.unsaved {
      background: var(--warning-color);
    }

    .save-indicator.saving {
      background: var(--primary-color);
      animation: pulse 1s infinite;
    }

    .save-indicator.closed {
      background: var(--disabled-color);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* æœç´¢æ¡† */
    .search-container {
      padding: 8px 16px;
      border-bottom: 1px solid var(--border-color);
      background: var(--button-bg);
    }

    .search-input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
      background: var(--bg-secondary);
      color: var(--text-color);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .file-tree {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .tree-item {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      margin: 1px 0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      user-select: none;
    }

    .tree-item:hover {
      background: var(--button-hover);
    }

    .tree-item.selected {
      background: var(--primary-color);
      color: white;
    }

    .tree-item.current {
      background: color-mix(in srgb, var(--primary-color) 20%, transparent);
      border-left: 3px solid var(--primary-color);
    }

    .tree-item.search-result {
      background: color-mix(in srgb, var(--warning-color) 20%, transparent);
      border-left: 3px solid var(--warning-color);
    }

    .tree-indent {
      display: inline-block;
    }

    .tree-toggle {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 4px;
      border-radius: 2px;
      font-size: 12px;
      color: var(--text-secondary);
      transition: all 0.2s;
      cursor: pointer;
    }

    .tree-toggle:hover {
      background: var(--button-hover);
    }

    .tree-toggle.expanded {
      transform: rotate(90deg);
    }

    .tree-icon {
      margin-right: 6px;
      font-size: 14px;
    }

    .tree-label {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .file-input {
      display: none;
    }

    /* é€šçŸ¥æç¤º */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 12px 16px;
      box-shadow: var(--shadow);
      z-index: 1001;
      display: none;
      max-width: 300px;
    }

    .notification.success {
      border-left: 4px solid var(--success-color);
    }

    .notification.warning {
      border-left: 4px solid var(--warning-color);
    }

    .notification.info {
      border-left: 4px solid var(--primary-color);
    }

    .notification.show {
      display: block;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* å³é”®èœå• */
    .context-menu {
      position: fixed;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      box-shadow: var(--shadow);
      z-index: 1000;
      min-width: 150px;
      display: none;
    }

    .context-menu-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-color);
      transition: background-color 0.2s;
    }

    .context-menu-item:hover {
      background: var(--button-hover);
    }

    .context-menu-item:first-child {
      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
    }

    .context-menu-item:last-child {
      border-bottom-left-radius: 5px;
      border-bottom-right-radius: 5px;
    }

    .context-menu-divider {
      height: 1px;
      background: var(--border-color);
      margin: 4px 0;
    }

    /* è·³è½¬è¡ŒåŠŸèƒ½ */
    .goto-line {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
      z-index: 100;
      width: 400px;
    }

    .goto-line .input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .goto-line input {
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 10px 12px;
      flex: 1;
      background: var(--bg-secondary);
      color: var(--text-color);
      font-size: 16px;
    }

    .goto-line .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .goto-line button {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
    }

    .goto-line .close-text {
      color: var(--text-secondary);
      cursor: pointer;
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 6px;
      transition: all 0.2s;
      background: var(--button-bg);
      border: 1px solid var(--border-color);
    }

    .goto-line .close-text:hover {
      color: var(--text-color);
      background: var(--button-hover);
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: var(--bg-secondary);
      margin: 5% auto;
      padding: 0;
      border: none;
      border-radius: 8px;
      width: 80%;
      max-width: 900px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-header {
      background: var(--button-bg);
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-header .modal-icon {
      font-size: 20px;
    }

    .close {
      color: var(--text-secondary);
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover {
      color: var(--text-color);
    }

    .modal-body {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .modal-footer {
      background: var(--button-bg);
      padding: 16px 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .modal-footer button {
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
      border: 1px solid var(--primary-color);
    }

    .btn-primary:hover {
      background: color-mix(in srgb, var(--primary-color) 80%, black);
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
      border: 1px solid var(--danger-color);
    }

    .btn-danger:hover {
      background: color-mix(in srgb, var(--danger-color) 80%, black);
    }

    .btn-secondary {
      background: var(--button-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--button-hover);
    }

    /* æ–°å»ºæ–‡ä»¶æ¨¡æ€æ¡† */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-color);
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      background: var(--bg-secondary);
      color: var(--text-color);
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .quick-create-btn {
      background: var(--success-color);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 8px;
    }

    .quick-create-btn:hover {
      background: color-mix(in srgb, var(--success-color) 80%, black);
    }

    /* æœç´¢æ¨¡æ€æ¡† */
    .search-modal-content {
      width: 60%;
      max-width: 600px;
    }

    .search-results {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-top: 16px;
    }

    .search-result-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .search-result-item:hover {
      background: var(--button-hover);
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-name {
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 4px;
    }

    .search-result-path {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .search-result-preview {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
      max-height: 40px;
      overflow: hidden;
      line-height: 1.3;
    }

    /* è¡¨æ ¼ç¼–è¾‘å™¨æ ·å¼ä¼˜åŒ– */
    .table-controls {
      margin-bottom: 16px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      padding: 12px;
      background: var(--button-bg);
      border-radius: 6px;
    }

    .table-controls input, .table-controls select {
      padding: 6px 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-secondary);
      color: var(--text-color);
      font-size: 14px;
    }

    .table-controls button {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      color: var(--text-color);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
    }

    .table-controls button:hover {
      background: var(--button-hover);
      transform: translateY(-1px);
    }

    .table-controls .btn-success {
      background: var(--success-color);
      color: white;
      border-color: var(--success-color);
    }

    .table-controls .btn-warning {
      background: var(--warning-color);
      color: #212529;
      border-color: var(--warning-color);
    }

    .table-controls .btn-danger {
      background: var(--danger-color);
      color: white;
      border-color: var(--danger-color);
    }

    .table-editor {
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: auto;
      max-height: 400px;
    }

    .table-editor table {
      width: 100%;
      border-collapse: collapse;
    }

    .table-editor th,
    .table-editor td {
      border: 1px solid var(--border-color);
      padding: 8px;
      min-width: 100px;
      position: relative;
    }

    .table-editor th {
      background: var(--button-bg);
      font-weight: 600;
    }

    .table-editor tr:nth-child(even) td {
      background: var(--button-bg);
    }

    .table-editor input {
      width: 100%;
      border: none;
      outline: none;
      padding: 4px;
      background: transparent;
      color: var(--text-color);
    }

    .table-editor input:focus {
      background: var(--bg-secondary);
      box-shadow: inset 0 0 0 2px var(--primary-color);
      border-radius: 3px;
    }

    .paste-area {
      margin-bottom: 16px;
      padding: 16px;
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      text-align: center;
      color: var(--text-secondary);
      cursor: pointer;
      background: var(--button-bg);
      transition: all 0.2s;
    }

    .paste-area:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
      background: color-mix(in srgb, var(--primary-color) 5%, transparent);
    }

    /* ä»£ç é€‰æ‹©å™¨ä¼˜åŒ– */
    .code-selector {
      margin-bottom: 16px;
      padding: 12px;
      background: var(--button-bg);
      border-radius: 6px;
    }

    .code-selector label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-color);
    }

    .code-selector select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-secondary);
      color: var(--text-color);
      font-size: 14px;
    }

    .code-textarea {
      width: 100%;
      min-height: 300px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      padding: 16px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      resize: vertical;
      background: var(--bg-secondary);
      color: var(--text-color);
      font-size: 14px;
      line-height: 1.5;
    }

    .theme-selector {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .theme-btn {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--border-color);
      cursor: pointer;
      transition: all 0.2s;
    }

    .theme-btn.light { background: #f5f5f5; }
    .theme-btn.dark { background: #0d1117; }
    .theme-btn.green { background: #f0f4e8; }

    .theme-btn.active {
      border-color: var(--primary-color);
      transform: scale(1.1);
    }

    /* Markdown æ ·å¼ */
    .preview h1, .preview h2, .preview h3, .preview h4, .preview h5, .preview h6 {
      margin: 24px 0 16px 0;
      font-weight: 600;
      line-height: 1.25;
      color: var(--text-color);
    }

    .preview h1 { font-size: 2em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
    .preview h2 { font-size: 1.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
    .preview h3 { font-size: 1.25em; }
    .preview h4 { font-size: 1em; }
    .preview h5 { font-size: 0.875em; }
    .preview h6 { font-size: 0.85em; color: var(--text-secondary); }

    .preview p {
      margin: 0 0 16px 0;
      line-height: 1.6;
      color: var(--text-color);
    }

    .preview ul, .preview ol {
      margin: 0 0 16px 0;
      padding-left: 2em;
    }

    .preview li {
      margin: 0.25em 0;
      color: var(--text-color);
    }

    .preview blockquote {
      margin: 16px 0;
      padding: 16px 20px;
      background: var(--quote-bg);
      border-left: 4px solid var(--primary-color);
      border-radius: 0 6px 6px 0;
      position: relative;
      font-style: italic;
      color: var(--text-secondary);
    }

    .preview blockquote::before {
      content: '"';
      font-size: 3em;
      color: var(--primary-color);
      position: absolute;
      left: 8px;
      top: -8px;
      line-height: 1;
      opacity: 0.3;
    }

    .preview blockquote p {
      margin: 0;
      position: relative;
      z-index: 1;
    }

    .preview blockquote p:last-child {
      margin-bottom: 0;
    }

    .preview code {
      background: var(--button-bg);
      border-radius: 3px;
      font-size: 85%;
      margin: 0;
      padding: 0.2em 0.4em;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      color: var(--text-color);
    }

    .preview pre {
      background: var(--button-bg);
      border-radius: 6px;
      font-size: 85%;
      line-height: 1.45;
      overflow: auto;
      padding: 16px;
      margin: 0 0 16px 0;
    }

    .preview pre code {
      background: transparent;
      border: 0;
      display: inline;
      line-height: inherit;
      margin: 0;
      max-width: auto;
      overflow: visible;
      padding: 0;
      word-wrap: normal;
    }

    .preview table {
      border-collapse: collapse;
      margin: 0 0 16px 0;
      width: 100%;
    }

    .preview table th, .preview table td {
      border: 1px solid var(--border-color);
      padding: 6px 13px;
    }

    .preview table th {
      background: var(--button-bg);
      font-weight: 600;
    }

    .preview a {
      color: var(--primary-color);
      text-decoration: none;
    }

    .preview a:hover {
      text-decoration: underline;
    }

    .preview img {
      max-width: 100%;
      height: auto;
    }

    .preview hr {
      border: none;
      height: 0.25em;
      background: var(--border-color);
      margin: 24px 0;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1024px) {
      .file-panel {
        width: 250px;
      }
    }

    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }

      .editor-section {
        border-right: none;
        border-bottom: 1px solid var(--border-color);
      }

      .preview-section.hidden, .file-panel.hidden {
        display: none;
      }

      .toolbar {
        padding: 8px 12px;
      }

      .toolbar button {
        padding: 6px 10px;
        font-size: 12px;
      }

      .modal-content {
        width: 95%;
        margin: 2% auto;
      }

      .file-panel {
        width: 100%;
        position: absolute;
        right: 0;
        top: 0;
        height: 100%;
        z-index: 100;
      }

      .line-numbers {
        min-width: 40px;
        padding: 16px 4px;
      }

      .notification {
        right: 10px;
        max-width: 250px;
      }
    }

    /* ç§»åŠ¨æ–‡ä»¶å¤¹é€‰æ‹©åˆ—è¡¨æ ·å¼ */
    .folder-item {
      padding: 8px;
      cursor: pointer;
      border-radius: 4px;
      margin: 2px 0;
      transition: all 0.2s;
    }

    .folder-item:hover {
      background: var(--button-hover);
    }

    .folder-item.selected {
      background: var(--primary-color);
      color: white;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="toolbar">
    <button onclick="openNewFileModal()" title="æ–°å»ºæ–‡æ¡£ (Ctrl+N)" class="success-btn">
      ğŸ“ æ–°å»º
    </button>
    <button onclick="closeCurrentFile()" title="å…³é—­å½“å‰æ–‡ä»¶" class="danger-btn" id="closeFileBtn" disabled>
      âŒ å…³é—­
    </button>

    <div class="divider"></div>

    <button onclick="insertMarkdown('**', '**')" title="ç²—ä½“ (Ctrl+B)" id="boldBtn">
      <strong>B</strong>
    </button>
    <button onclick="insertMarkdown('*', '*')" title="æ–œä½“ (Ctrl+I)" id="italicBtn">
      <em>I</em>
    </button>
    <button onclick="insertMarkdown('~~', '~~')" title="åˆ é™¤çº¿" id="strikeBtn">
      <s>S</s>
    </button>
    <button onclick="insertMarkdown('`', '`')" title="è¡Œå†…ä»£ç " id="codeBtn">
      &lt;/&gt;
    </button>

    <div class="divider"></div>

    <button onclick="insertHeading(1)" title="æ ‡é¢˜ 1" id="h1Btn">H1</button>
    <button onclick="insertHeading(2)" title="æ ‡é¢˜ 2" id="h2Btn">H2</button>
    <button onclick="insertHeading(3)" title="æ ‡é¢˜ 3" id="h3Btn">H3</button>

    <div class="divider"></div>

    <button onclick="insertSmartList('- ')" title="æ— åºåˆ—è¡¨" id="ulBtn">â€¢ åˆ—è¡¨</button>
    <button onclick="insertSmartList('1. ')" title="æœ‰åºåˆ—è¡¨" id="olBtn">1. åˆ—è¡¨</button>
    <button onclick="insertQuote()" title="å¼•ç”¨" id="quoteBtn">â å¼•ç”¨</button>
    <button onclick="insertDivider()" title="åˆ†å‰²çº¿" id="dividerBtn">-- åˆ†å‰²çº¿</button>

    <div class="divider"></div>

    <button onclick="insertLink()" title="é“¾æ¥" id="linkBtn">ğŸ”— é“¾æ¥</button>
    <button onclick="insertImage()" title="å›¾ç‰‡" id="imageBtn">ğŸ–¼ï¸ å›¾ç‰‡</button>
    <button onclick="openTableEditor()" title="è¡¨æ ¼ç¼–è¾‘å™¨" id="tableBtn">ğŸ“Š è¡¨æ ¼</button>
    <button onclick="openCodeBlock()" title="ä»£ç ç¼–è¾‘å™¨" id="codeBlockBtn">ğŸ’» ä»£ç </button>

    <div class="divider"></div>

    <button onclick="showGotoLine()" title="è·³è½¬åˆ°è¡Œ (Ctrl+G)" id="gotoBtn">ğŸ¯ è·³è½¬è¡Œ</button>
    <button onclick="confirmClearEditor()" title="æ¸…ç©ºç¼–è¾‘å™¨ (Ctrl+Alt+C)" class="danger-btn" id="clearBtn">ğŸ—‘ï¸ æ¸…ç©º</button>

    <div class="divider"></div>

    <div class="theme-selector">
      <span style="font-size: 12px; margin-right: 4px;">ä¸»é¢˜:</span>
      <div class="theme-btn light" onclick="setTheme('light')" title="æµ…è‰²æ¨¡å¼"></div>
      <div class="theme-btn dark" onclick="setTheme('dark')" title="æ·±è‰²æ¨¡å¼"></div>
      <div class="theme-btn green" onclick="setTheme('green')" title="è±†æ²™ç»¿"></div>
    </div>

    <div class="divider"></div>

    <button onclick="document.getElementById('fileInput').click()" title="æ‰“å¼€æ–‡ä»¶">ğŸ“ æ‰“å¼€</button>
    <button onclick="saveFile()" title="ä¿å­˜æ–‡ä»¶ (Ctrl+S)" id="saveBtn">ğŸ’¾ ä¿å­˜</button>
    <button id="togglePreview" onclick="togglePreview()" title="åˆ‡æ¢é¢„è§ˆ">ğŸ‘ï¸ é¢„è§ˆ</button>
    <button id="toggleFilePanel" onclick="toggleFilePanel()" title="æ–‡ä»¶ç®¡ç†">ğŸ“‚ æ–‡ä»¶</button>

    <input type="file" id="fileInput" class="file-input" accept=".md,.txt" onchange="loadFile(event)">

    <div class="goto-line" id="gotoLine">
      <div class="input-group">
        <input type="number" id="gotoLineInput" placeholder="è¡Œå·" min="1">
        <button onclick="gotoLine()">è·³è½¬</button>
        <span class="close-text" onclick="hideGotoLine()">å…³é—­</span>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="editor-section" id="editorSection">
      <div class="editor-header">
        <span>ç¼–è¾‘å™¨</span>
        <span style="font-size: 12px;">è¡Œ: <span id="currentLine">1</span> | åˆ—: <span id="currentCol">1</span> | å­—æ•°: <span id="wordCount">0</span></span>
      </div>
      <div class="editor-container">
        <div class="line-numbers" id="lineNumbers"></div>
        <textarea id="editor" class="editor" placeholder="åœ¨è¿™é‡Œè¾“å…¥ Markdown å†…å®¹...">
# æ¬¢è¿ä½¿ç”¨å¢å¼ºç‰ˆ Markdown ç¼–è¾‘å™¨

è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å…¨é¢çš„ **Markdown ç¼–è¾‘å™¨**ï¼Œç°åœ¨æ”¯æŒæ›´å¤šé«˜çº§åŠŸèƒ½ï¼

## ğŸš€ æ–°å¢åŠŸèƒ½

- âœ… **æ™ºèƒ½æ–°å»º**ï¼šé€‰æ‹©æ–‡ä»¶å¤¹åè¾“å…¥æ–‡ä»¶åæˆ–å¿«é€Ÿåˆ›å»º
- âœ… **æ–‡ä»¶æœç´¢**ï¼šæ¨¡æ€æœç´¢å¿«é€ŸæŸ¥æ‰¾æ–‡ä»¶
- âœ… **ç›®å½•æ ‘ä¼˜åŒ–**ï¼šç¼©è¿›å±•ç¤ºæ–‡ä»¶å¤¹å±‚æ¬¡ç»“æ„
- âœ… **æ–‡ä»¶å¤¹ç§»åŠ¨**ï¼šæ”¯æŒæ–‡ä»¶å¤¹çš„ç§»åŠ¨æ“ä½œ
- âœ… **ä¸´æ—¶æ–‡ä»¶å¤¹**ï¼šè‡ªåŠ¨åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜æ”¾åŒº

## âŒ¨ï¸ å¿«æ·é”®

- **Ctrl+N**: æ–°å»ºæ–‡æ¡£
- **Ctrl+F**: æœç´¢æ–‡ä»¶
- **Ctrl+B**: ç²—ä½“
- **Ctrl+I**: æ–œä½“
- **Ctrl+S**: ä¿å­˜æ–‡ä»¶
- **Ctrl+G**: è·³è½¬åˆ°æŒ‡å®šè¡Œ

## ğŸ“ æ–‡ä»¶ç®¡ç†å¢å¼º

### æ™ºèƒ½æ–°å»º
1. ç‚¹å‡»"ğŸ“ æ–°å»º"æŒ‰é’®
2. é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹
3. è¾“å…¥æ–‡ä»¶åæˆ–ç‚¹å‡»"âš¡ å¿«é€Ÿåˆ›å»º"

### æ–‡ä»¶æœç´¢
- ä½¿ç”¨æœç´¢æ¡†æˆ–å¿«æ·é”® Ctrl+F
- è¾“å…¥å…³é”®è¯æœç´¢æ–‡ä»¶åå’Œå†…å®¹
- ç‚¹å‡»æœç´¢ç»“æœç›´æ¥æ‰“å¼€æ–‡ä»¶

### ç›®å½•æ ‘ç»“æ„
```
ğŸ“ æˆ‘çš„æ–‡æ¡£
  â”œâ”€â”€ ğŸ“„ å·¥ä½œç¬”è®°.md
  â”œâ”€â”€ ğŸ“ é¡¹ç›®æ–‡æ¡£
  â”‚   â”œâ”€â”€ ğŸ“„ éœ€æ±‚åˆ†æ.md
  â”‚   â””â”€â”€ ğŸ“„ æŠ€æœ¯æ–¹æ¡ˆ.md
  â””â”€â”€ ğŸ“ ä¸´æ—¶æ–‡ä»¶
      â””â”€â”€ ğŸ“„ ä¸´æ—¶æ–‡ä»¶1.md
```

## ğŸ“Š åºå·åˆ—è¡¨æ¼”ç¤º

1. ç¬¬ä¸€é¡¹å†…å®¹
2. ç¬¬äºŒé¡¹å†…å®¹
3. ç¬¬ä¸‰é¡¹å†…å®¹
   1. å­é¡¹ç›® 1
   2. å­é¡¹ç›® 2

## ğŸ“ å¼•ç”¨æ•ˆæœæ¼”ç¤º

> è¿™æ˜¯ä¸€ä¸ªå¢å¼ºçš„å¼•ç”¨å—ç¤ºä¾‹
> ç°åœ¨å…·æœ‰æ›´å¥½çš„è§†è§‰æ•ˆæœ
>
> æ”¯æŒå¤šæ®µè½å¼•ç”¨å†…å®¹

> ğŸ’¡ æç¤ºï¼šæ‰€æœ‰åŠŸèƒ½éƒ½å·²ç»è¿‡ä¼˜åŒ–ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼

---

å°è¯•ç‚¹å‡»"ğŸ“ æ–°å»º"æŒ‰é’®ä½“éªŒæ–°çš„æ–‡ä»¶åˆ›å»ºæµç¨‹ï¼
ä½¿ç”¨æœç´¢åŠŸèƒ½å¿«é€ŸæŸ¥æ‰¾æ‚¨çš„æ–‡ä»¶ï¼
                    </textarea>
        <div class="editor-locked-overlay" id="editorLockedOverlay">
          <div class="locked-message">
            <h3>ğŸ”’ ç¼–è¾‘å™¨å·²é”å®š</h3>
            <p>å½“å‰æ²¡æœ‰æ‰“å¼€çš„æ–‡ä»¶ã€‚è¯·æ–°å»ºæ–‡æ¡£æˆ–æ‰“å¼€ç°æœ‰æ–‡ä»¶æ¥å¼€å§‹ç¼–è¾‘ã€‚</p>
            <button onclick="openNewFileModal()" class="btn-primary">ğŸ“ æ–°å»ºæ–‡æ¡£</button>
          </div>
        </div>
      </div>
    </div>

    <div id="previewSection" class="preview-section">
      <div class="preview-header">é¢„è§ˆ</div>
      <div id="preview" class="preview"></div>
    </div>

    <div id="filePanel" class="file-panel">
      <div class="file-panel-header">
        æ–‡ä»¶ç®¡ç†
        <div class="file-panel-controls">
          <button onclick="openSearchModal()" title="æœç´¢æ–‡ä»¶ (Ctrl+F)">ğŸ”</button>
          <button onclick="createFolder()" title="æ–°å»ºæ–‡ä»¶å¤¹">ğŸ“</button>
          <button onclick="exportData()" title="å¯¼å‡ºæ•°æ®">ğŸ“¤</button>
          <button onclick="importData()" title="å¯¼å…¥æ•°æ®">ğŸ“¥</button>
        </div>
      </div>
      <div class="current-file-info" id="currentFileInfo">
        <div>
          <div style="font-size: 10px; color: var(--text-secondary);">å½“å‰æ–‡ä»¶:</div>
          <div class="file-name">ä¸´æ—¶æ–‡ä»¶</div>
        </div>
        <div class="save-status">
          <div class="save-indicator saved" id="saveIndicator"></div>
          <span id="saveStatusText">ä¸´æ—¶æ–‡ä»¶</span>
        </div>
      </div>
      <div class="search-container">
        <input type="text" class="search-input" id="quickSearch" placeholder="å¿«é€Ÿæœç´¢æ–‡ä»¶..." oninput="quickSearchFiles()">
      </div>
      <div id="fileTree" class="file-tree"></div>
      <input type="file" id="importInput" class="file-input" accept=".json" onchange="handleImport(event)">
    </div>
  </div>
</div>

<!-- é€šçŸ¥æç¤º -->
<div id="notification" class="notification">
  <div id="notificationContent"></div>
</div>

<!-- å³é”®èœå• -->
<div id="contextMenu" class="context-menu">
  <div class="context-menu-item" onclick="openSelectedFile()">ğŸ“– æ‰“å¼€æ–‡ä»¶</div>
  <div class="context-menu-item" onclick="renameFile()">âœï¸ é‡å‘½å</div>
  <div class="context-menu-item" onclick="moveFile()">ğŸ“ ç§»åŠ¨</div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="deleteFileConfirm()" style="color: var(--danger-color);">ğŸ—‘ï¸ åˆ é™¤</div>
</div>

<!-- æ–°å»ºæ–‡ä»¶æ¨¡æ€æ¡† -->
<div id="newFileModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><span class="modal-icon">ğŸ“</span>æ–°å»ºæ–‡æ¡£</h3>
      <span class="close" onclick="closeNewFileModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="parentFolder">é€‰æ‹©æ–‡ä»¶å¤¹:</label>
        <select id="parentFolder">
          <option value="">æ ¹ç›®å½•</option>
        </select>
      </div>
      <div class="form-group">
        <label for="fileName">æ–‡ä»¶å:
          <button class="quick-create-btn" onclick="quickCreateFile()">âš¡ å¿«é€Ÿåˆ›å»º</button>
        </label>
        <input type="text" id="fileName" placeholder="è¯·è¾“å…¥æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeNewFileModal()">å–æ¶ˆ</button>
      <button class="btn-primary" onclick="createNewFile()">ğŸ“ åˆ›å»ºæ–‡æ¡£</button>
    </div>
  </div>
</div>

<!-- æœç´¢æ¨¡æ€æ¡† -->
<div id="searchModal" class="modal">
  <div class="modal-content search-modal-content">
    <div class="modal-header">
      <h3><span class="modal-icon">ğŸ”</span>æœç´¢æ–‡ä»¶</h3>
      <span class="close" onclick="closeSearchModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <input type="text" id="searchInput" placeholder="æœç´¢æ–‡ä»¶åæˆ–å†…å®¹..." oninput="performSearch()">
      </div>
      <div id="searchResults" class="search-results"></div>
    </div>
  </div>
</div>

<!-- è¡¨æ ¼ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
<div id="tableModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><span class="modal-icon">ğŸ“Š</span>é«˜çº§è¡¨æ ¼ç¼–è¾‘å™¨</h3>
      <span class="close" onclick="closeTableModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="paste-area" onclick="focusPasteArea()" id="pasteArea">
        <div style="font-size: 16px; margin-bottom: 8px;">ğŸ“‹ Excel æ•°æ®å¯¼å…¥</div>
        <div>ä» Excel å¤åˆ¶è¡¨æ ¼æ•°æ®ï¼Œç„¶åç‚¹å‡»è¿™é‡Œç²˜è´´</div>
        <textarea id="pasteInput" style="opacity: 0; position: absolute; left: -9999px;"></textarea>
      </div>

      <div class="table-controls">
        <label>ğŸ“ è¡Œæ•°: <input type="number" id="tableRows" value="3" min="1" max="20"></label>
        <label>ğŸ“ åˆ—æ•°: <input type="number" id="tableCols" value="3" min="1" max="10"></label>
        <button onclick="generateTable()" class="btn-success">ğŸ”„ ç”Ÿæˆè¡¨æ ¼</button>
        <label>
          <input type="checkbox" id="alternateRows" checked> ğŸ¨ éš”è¡Œå˜è‰²
        </label>
        <button onclick="addTableRow()" class="btn-success">â• æ·»åŠ è¡Œ</button>
        <button onclick="addTableCol()" class="btn-success">â• æ·»åŠ åˆ—</button>
        <button onclick="clearTable()" class="btn-warning">ğŸ§¹ æ¸…ç©ºå†…å®¹</button>
        <button onclick="resetTable()" class="btn-danger">ğŸ—‘ï¸ é‡ç½®è¡¨æ ¼</button>
      </div>
      <div id="tableEditor" class="table-editor"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeTableModal()">å–æ¶ˆ</button>
      <button class="btn-primary" onclick="insertTableFromEditor()">ğŸ“Š æ’å…¥è¡¨æ ¼</button>
    </div>
  </div>
</div>

<!-- ä»£ç å—æ¨¡æ€æ¡† -->
<div id="codeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><span class="modal-icon">ğŸ’»</span>é«˜çº§ä»£ç ç¼–è¾‘å™¨</h3>
      <span class="close" onclick="closeCodeModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="code-selector">
        <label for="codeLanguage">ğŸ”¤ é€‰æ‹©ç¼–ç¨‹è¯­è¨€:</label>
        <select id="codeLanguage">
          <option value="">æ— è¯­è¨€</option>
          <option value="javascript">JavaScript</option>
          <option value="vue">Vue.js</option>
          <option value="php">PHP</option>
          <option value="python">Python</option>
          <option value="json">JSON</option>
          <option value="html">HTML</option>
          <option value="css">CSS</option>
          <option value="java">Java</option>
          <option value="cpp">C++</option>
          <option value="csharp">C#</option>
          <option value="go">Go</option>
          <option value="rust">Rust</option>
          <option value="typescript">TypeScript</option>
          <option value="sql">SQL</option>
          <option value="bash">Bash</option>
          <option value="xml">XML</option>
          <option value="yaml">YAML</option>
          <option value="markdown">Markdown</option>
        </select>
      </div>
      <textarea id="codeContent" class="code-textarea" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä»£ç ...

ğŸ’¡ æç¤º:
- æ”¯æŒè¯­æ³•é«˜äº®
- è‡ªåŠ¨ç¼©è¿›
- ä»£ç è¡¥å…¨"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeCodeModal()">å–æ¶ˆ</button>
      <button class="btn-primary" onclick="insertCodeFromModal()">ğŸ’» æ’å…¥ä»£ç </button>
    </div>
  </div>
</div>

<!-- ç§»åŠ¨æ–‡ä»¶æ¨¡æ€æ¡† -->
<div id="moveFileModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><span class="modal-icon">ğŸ“</span>ç§»åŠ¨æ–‡ä»¶</h3>
      <span class="close" onclick="closeMoveFileModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div style="margin-bottom: 16px;">
        <strong>ç§»åŠ¨é¡¹ç›®:</strong> <span id="moveItemName"></span>
      </div>
      <div style="margin-bottom: 16px;">
        é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹ï¼š
      </div>
      <div id="folderList" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 8px;">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeMoveFileModal()">å–æ¶ˆ</button>
      <button class="btn-primary" onclick="confirmMoveFile()">ğŸ“ ç§»åŠ¨</button>
    </div>
  </div>
</div>

<script>
  // IndexedDB ç®¡ç†ç±»
  class FileManager {
    constructor() {
      this.dbName = 'MarkdownEditor';
      this.version = 1;
      this.db = null;
      this.init();
    }

    async init() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(this.dbName, this.version);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          this.db = request.result;
          resolve();
        };

        request.onupgradeneeded = (event) => {
          const db = event.target.result;

          if (!db.objectStoreNames.contains('files')) {
            const store = db.createObjectStore('files', { keyPath: 'id' });
            store.createIndex('parentId', 'parentId', { unique: false });
          }
        };
      });
    }

    async saveFile(file) {
      const transaction = this.db.transaction(['files'], 'readwrite');
      const store = transaction.objectStore('files');
      return store.put(file);
    }

    async getFiles() {
      const transaction = this.db.transaction(['files'], 'readonly');
      const store = transaction.objectStore('files');
      return new Promise((resolve) => {
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
      });
    }

    async deleteFile(id) {
      const transaction = this.db.transaction(['files'], 'readwrite');
      const store = transaction.objectStore('files');
      return store.delete(id);
    }

    generateId() {
      return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
  }

  // æ”¹è¿›çš„ Markdown è§£æå™¨
  class MarkdownParser {
    parse(markdown) {
      let html = markdown;

      // è½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦ (åœ¨ä»£ç å—ä¹‹å‰)
      const codeBlocks = [];
      const inlineCodes = [];

      // å…ˆæå–ä»£ç å—ï¼Œé¿å…è¢«è½¬ä¹‰
      html = html.replace(/```[\s\S]*?```/g, function(match, offset) {
        const index = codeBlocks.length;
        codeBlocks.push(match);
        return `__CODEBLOCK_${index}__`;
      });

      // æå–è¡Œå†…ä»£ç 
      html = html.replace(/`[^`\n]+`/g, function(match, offset) {
        const index = inlineCodes.length;
        inlineCodes.push(match);
        return `__INLINECODE_${index}__`;
      });

      // è½¬ä¹‰ HTML æ ‡ç­¾
      html = html.replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;');

      // å¤„ç†ä»£ç å— - è½¬ä¹‰å†…å®¹
      html = html.replace(/__CODEBLOCK_(\d+)__/g, function(match, index) {
        const codeBlock = codeBlocks[index];
        const match2 = codeBlock.match(/```(\w*)\n?([\s\S]*?)```/);
        if (match2) {
          const language = match2[1] || '';
          let code = match2[2];
          // å†æ¬¡è½¬ä¹‰ä»£ç å—å†…å®¹ï¼Œé˜²æ­¢HTMLæ³¨å…¥
          code = code.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;');
          return `<pre><code class="language-${language}">${code}</code></pre>`;
        }
        return codeBlock;
      });

      // å¤„ç†è¡Œå†…ä»£ç  - è½¬ä¹‰å†…å®¹
      html = html.replace(/__INLINECODE_(\d+)__/g, function(match, index) {
        const inlineCode = inlineCodes[index];
        let code = inlineCode.slice(1, -1); // ç§»é™¤ `
        // è½¬ä¹‰è¡Œå†…ä»£ç å†…å®¹
        code = code.replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        return `<code>${code}</code>`;
      });

      // æ ‡é¢˜
      html = html.replace(/^######\s+(.*$)/gm, '<h6>$1</h6>');
      html = html.replace(/^#####\s+(.*$)/gm, '<h5>$1</h5>');
      html = html.replace(/^####\s+(.*$)/gm, '<h4>$1</h4>');
      html = html.replace(/^###\s+(.*$)/gm, '<h3>$1</h3>');
      html = html.replace(/^##\s+(.*$)/gm, '<h2>$1</h2>');
      html = html.replace(/^#\s+(.*$)/gm, '<h1>$1</h1>');

      // ç²—ä½“å’Œæ–œä½“
      html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
      html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

      // åˆ é™¤çº¿
      html = html.replace(/~~(.*?)~~/g, '<s>$1</s>');

      // é“¾æ¥
      html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

      // å›¾ç‰‡
      html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');

      // æ°´å¹³çº¿
      html = html.replace(/^---+$/gm, '<hr>');

      // å¼•ç”¨ - å¢å¼ºå¤„ç†
      html = html.replace(/^>\s+(.*$)/gm, function(match, content) {
        return `<blockquote><p>${content}</p></blockquote>`;
      });

      // åˆå¹¶è¿ç»­çš„å¼•ç”¨
      html = html.replace(/(<\/blockquote>\s*<blockquote>)/g, '');

      // è¡¨æ ¼ - æ”¹è¿›çš„æ­£åˆ™è¡¨è¾¾å¼
      html = html.replace(/^\|(.+)\|[ \t]*\n\|(.+)\|[ \t]*\n((?:\|.+\|[ \t]*(?:\n|$))+)/gm, function(match, header, separator, rows) {
        // å¤„ç†è¡¨å¤´
        const headerCells = header.split('|')
                .map(cell => cell.trim())
                .filter(cell => cell)
                .map(cell => `<th>${cell}</th>`)
                .join('');

        // å¤„ç†è¡¨æ ¼è¡Œ
        const tableRows = rows.trim().split('\n')
                .map(row => {
                  const cells = row.split('|')
                          .map(cell => cell.trim())
                          .filter(cell => cell)
                          .map(cell => `<td>${cell}</td>`)
                          .join('');
                  return `<tr>${cells}</tr>`;
                })
                .join('');

        return `<table><thead><tr>${headerCells}</tr></thead><tbody>${tableRows}</tbody></table>`;
      });

      // åˆ—è¡¨å¤„ç†
      const lines = html.split('\n');
      let inOrderedList = false;
      let inUnorderedList = false;
      let result = [];

      for (let i = 0; i < lines.length; i++) {
        let line = lines[i];

        // æœ‰åºåˆ—è¡¨
        if (/^\d+\.\s+/.test(line)) {
          if (!inOrderedList) {
            if (inUnorderedList) {
              result.push('</ul>');
              inUnorderedList = false;
            }
            result.push('<ol>');
            inOrderedList = true;
          }
          line = line.replace(/^\d+\.\s+/, '<li>') + '</li>';
        }
        // æ— åºåˆ—è¡¨
        else if (/^[-*+]\s+/.test(line)) {
          if (!inUnorderedList) {
            if (inOrderedList) {
              result.push('</ol>');
              inOrderedList = false;
            }
            result.push('<ul>');
            inUnorderedList = true;
          }
          line = line.replace(/^[-*+]\s+/, '<li>') + '</li>';
        }
        // éåˆ—è¡¨è¡Œ
        else {
          if (inOrderedList) {
            result.push('</ol>');
            inOrderedList = false;
          }
          if (inUnorderedList) {
            result.push('</ul>');
            inUnorderedList = false;
          }
        }

        result.push(line);
      }

      // å…³é—­æœªé—­åˆçš„åˆ—è¡¨
      if (inOrderedList) result.push('</ol>');
      if (inUnorderedList) result.push('</ul>');

      html = result.join('\n');

      // æ®µè½å¤„ç†
      html = html.replace(/\n\s*\n/g, '</p><p>');
      html = '<p>' + html + '</p>';

      // æ¸…ç†
      html = html.replace(/<p><\/p>/g, '');
      html = html.replace(/<p>(<h[1-6]>)/g, '$1');
      html = html.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
      html = html.replace(/<p>(<ul>|<ol>|<blockquote>|<pre>|<table>|<hr>)/g, '$1');
      html = html.replace(/(<\/ul>|<\/ol>|<\/blockquote>|<\/pre>|<\/table>|<hr>)<\/p>/g, '$1');
      html = html.replace(/<p>(<li>)/g, '$1');
      html = html.replace(/(<\/li>)<\/p>/g, '$1');

      // æ¢è¡Œ
      html = html.replace(/\n/g, '<br>');

      return html;
    }
  }

  // å…¨å±€å˜é‡
  const parser = new MarkdownParser();
  const fileManager = new FileManager();
  const editor = document.getElementById('editor');
  const preview = document.getElementById('preview');
  const previewSection = document.getElementById('previewSection');
  const filePanel = document.getElementById('filePanel');
  const togglePreviewButton = document.getElementById('togglePreview');
  const toggleFilePanelButton = document.getElementById('toggleFilePanel');
  const lineNumbers = document.getElementById('lineNumbers');

  let previewVisible = true;
  let filePanelVisible = true;
  let currentFileId = null;
  let currentFileName = 'ä¸´æ—¶æ–‡ä»¶';
  let currentTheme = 'light';
  let saveStatus = 'saved'; // 'saved', 'unsaved', 'saving', 'closed'
  let selectedFileForContext = null;
  let selectedFolderForMove = null;
  let autoSaveTimeout = null;
  let isEditorLocked = false;
  let tempFileCounter = 1;
  let tempFolderId = null;
  let allFiles = [];
  let expandedFolders = new Set(); // è¿½è¸ªå±•å¼€çš„æ–‡ä»¶å¤¹

  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', async function() {
    await fileManager.init();
    await ensureTempFolder();
    updatePreview();
    updateLineNumbers();
    updateFileInfo();
    updateSaveStatus();
    loadFileTree();
    loadTheme();
    updateThemeButtons();
    updateStatusBar();
    updateToolbarState();

    // é»˜è®¤æ˜¯ä¸´æ—¶æ–‡ä»¶çŠ¶æ€
    markAsTempFile();

    // åŒæ­¥æ»šåŠ¨
    editor.addEventListener('scroll', syncLineNumbers);
  });

  // ä¿®å¤æ»šåŠ¨åŒæ­¥
  function syncLineNumbers() {
    lineNumbers.scrollTop = editor.scrollTop;
  }

  // ä¿®å¤è¡Œå·æ›´æ–°
  function updateLineNumbers() {
    const lines = editor.value.split('\n');
    const lineNumberElements = [];

    for (let i = 0; i < lines.length; i++) {
      const lineDiv = document.createElement('div');
      lineDiv.className = 'line-number';
      lineDiv.textContent = i + 1;
      lineDiv.onclick = () => gotoSpecificLine(i + 1);
      lineNumberElements.push(lineDiv);
    }

    lineNumbers.innerHTML = '';
    lineNumberElements.forEach(el => lineNumbers.appendChild(el));
  }

  // ç¡®ä¿ä¸´æ—¶æ–‡ä»¶å¤¹å­˜åœ¨
  async function ensureTempFolder() {
    const files = await fileManager.getFiles();
    let tempFolder = files.find(f => f.type === 'folder' && f.name === 'ä¸´æ—¶æ–‡ä»¶');

    if (!tempFolder) {
      tempFolder = {
        id: fileManager.generateId(),
        name: 'ä¸´æ—¶æ–‡ä»¶',
        type: 'folder',
        parentId: null,
        createdAt: new Date().toISOString()
      };
      await fileManager.saveFile(tempFolder);
    }

    tempFolderId = tempFolder.id;
  }

  // æ™ºèƒ½åˆ—è¡¨æ’å…¥ - ä¿®å¤ç‰ˆæœ¬
  function getSmartListNumber(prefix) {
    const cursorPos = editor.selectionStart;
    const textBeforeCursor = editor.value.substring(0, cursorPos);
    const lines = textBeforeCursor.split('\n');

    // æ‰¾åˆ°å‰ä¸€è¡Œ
    for (let i = lines.length - 2; i >= 0; i--) {
      const line = lines[i].trim();
      if (!line) continue;

      if (prefix.includes('.')) {
        // æœ‰åºåˆ—è¡¨
        const match = line.match(/^(\d+(?:\.\d+)*)\.\s/);
        if (match) {
          const numbers = match[1].split('.');
          // é€’å¢æœ€åä¸€ä¸ªæ•°å­—
          numbers[numbers.length - 1] = (parseInt(numbers[numbers.length - 1]) + 1).toString();
          return numbers.join('.') + '. ';
        }
      } else {
        // æ— åºåˆ—è¡¨
        const match = line.match(/^([-*+])\s/);
        if (match) {
          return match[1] + ' ';
        }
      }
      break;
    }

    return prefix;
  }

  function insertSmartList(prefix) {
    const smartPrefix = getSmartListNumber(prefix);
    insertAtLineStart(smartPrefix);
  }

  // æ™ºèƒ½æ ‡é¢˜æ’å…¥ - æ–°å¢åŠŸèƒ½
  function getSmartHeadingText(level) {
    const cursorPos = editor.selectionStart;
    const textBeforeCursor = editor.value.substring(0, cursorPos);
    const lines = textBeforeCursor.split('\n');

    // æŸ¥æ‰¾åŒçº§åˆ«çš„æ ‡é¢˜
    const headingPrefix = '#'.repeat(level);
    let lastNumber = 0;

    for (let i = lines.length - 2; i >= 0; i--) {
      const line = lines[i].trim();
      if (!line) continue;

      // åŒ¹é…åŒçº§åˆ«æ ‡é¢˜
      const match = line.match(new RegExp(`^${headingPrefix}\\s+(\\d+)(?:\\.|\\s|$)`));
      if (match) {
        lastNumber = parseInt(match[1]);
        break;
      }

      // å¦‚æœé‡åˆ°æ›´é«˜çº§åˆ«çš„æ ‡é¢˜ï¼Œåœæ­¢æœç´¢
      const higherLevelMatch = line.match(/^(#{1,6})\s/);
      if (higherLevelMatch && higherLevelMatch[1].length < level) {
        break;
      }
    }

    return `${headingPrefix} ${lastNumber + 1}. `;
  }

  function insertHeading(level) {
    if (isEditorLocked) return;
    const smartPrefix = getSmartHeadingText(level);
    insertAtLineStart(smartPrefix);
  }

  // æ–‡ä»¶é”å®šç®¡ç†
  function lockEditor() {
    isEditorLocked = true;
    editor.disabled = true;
    document.getElementById('editorLockedOverlay').classList.add('show');
    document.getElementById('editorSection').classList.add('locked');
    updateToolbarState();
    saveStatus = 'closed';
    updateSaveStatus();
  }

  function unlockEditor() {
    isEditorLocked = false;
    editor.disabled = false;
    document.getElementById('editorLockedOverlay').classList.remove('show');
    document.getElementById('editorSection').classList.remove('locked');
    updateToolbarState();
  }

  function updateToolbarState() {
    const buttons = [
      'boldBtn', 'italicBtn', 'strikeBtn', 'codeBtn',
      'h1Btn', 'h2Btn', 'h3Btn',
      'ulBtn', 'olBtn', 'quoteBtn', 'dividerBtn',
      'linkBtn', 'imageBtn', 'tableBtn', 'codeBlockBtn',
      'gotoBtn', 'clearBtn'
    ];

    buttons.forEach(id => {
      const btn = document.getElementById(id);
      if (btn) {
        btn.disabled = isEditorLocked;
      }
    });

    // ä¿å­˜æŒ‰é’®çŠ¶æ€
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
      saveBtn.disabled = isEditorLocked || saveStatus === 'closed';
    }

    // å…³é—­æŒ‰é’®çŠ¶æ€
    const closeBtn = document.getElementById('closeFileBtn');
    if (closeBtn) {
      closeBtn.disabled = saveStatus === 'closed';
    }
  }

  // ä¸´æ—¶æ–‡ä»¶ç®¡ç†
  function markAsTempFile() {
    currentFileId = null;
    currentFileName = `ä¸´æ—¶æ–‡ä»¶${tempFileCounter}`;
    saveStatus = 'unsaved';
    updateFileInfo();
    updateSaveStatus();
    updateToolbarState();
  }

  function createTempFileIfNeeded() {
    if (!currentFileId && editor.value.trim()) {
      tempFileCounter++;
      markAsTempFile();
      showNotification('ğŸ“ å·²åˆ›å»ºä¸´æ—¶æ–‡ä»¶ä¿å­˜å†…å®¹', 'info');
    }
  }

  // å…³é—­å½“å‰æ–‡ä»¶
  async function closeCurrentFile() {
    if (saveStatus === 'closed') return;

    // å¦‚æœæœ‰æœªä¿å­˜çš„å†…å®¹
    if (saveStatus === 'unsaved' && editor.value.trim()) {
      if (confirm('æ–‡ä»¶æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ')) {
        if (currentFileId) {
          await saveCurrentFile();
        } else {
          // ä¸´æ—¶æ–‡ä»¶éœ€è¦å¦å­˜
          await saveFile();
          if (saveStatus === 'unsaved') {
            // ç”¨æˆ·å–æ¶ˆäº†ä¿å­˜
            return;
          }
        }
      }
    }

    // æ¸…ç©ºç¼–è¾‘å™¨å¹¶é”å®š
    editor.value = '';
    currentFileId = null;
    currentFileName = 'æ— æ–‡ä»¶';

    lockEditor();
    updatePreview();
    updateLineNumbers();
    updateFileInfo();
    loadFileTree();

    showNotification('âŒ æ–‡ä»¶å·²å…³é—­', 'info');
  }

  // é€šçŸ¥ç³»ç»Ÿ
  function showNotification(message, type = 'info', duration = 3000) {
    const notification = document.getElementById('notification');
    const content = document.getElementById('notificationContent');

    content.textContent = message;
    notification.className = `notification ${type} show`;

    setTimeout(() => {
      notification.classList.remove('show');
    }, duration);
  }

  // æ–°å»ºæ–‡æ¡£ç›¸å…³
  function openNewFileModal() {
    loadFolderOptions();
    document.getElementById('newFileModal').style.display = 'block';
    document.getElementById('fileName').focus();
  }

  function closeNewFileModal() {
    document.getElementById('newFileModal').style.display = 'none';
    document.getElementById('fileName').value = '';
    document.getElementById('parentFolder').value = '';
  }

  async function loadFolderOptions() {
    const files = await fileManager.getFiles();
    const folders = files.filter(f => f.type === 'folder');
    const select = document.getElementById('parentFolder');

    select.innerHTML = '<option value="">æ ¹ç›®å½•</option>';

    folders.forEach(folder => {
      const option = document.createElement('option');
      option.value = folder.id;
      option.textContent = folder.name;
      select.appendChild(option);
    });
  }

  function quickCreateFile() {
    const now = new Date();
    const timestamp = now.getFullYear() +
            String(now.getMonth() + 1).padStart(2, '0') +
            String(now.getDate()).padStart(2, '0') + '_' +
            String(now.getHours()).padStart(2, '0') +
            String(now.getMinutes()).padStart(2, '0') +
            String(now.getSeconds()).padStart(2, '0');

    const fileName = `æ–‡æ¡£_${timestamp}`;
    document.getElementById('fileName').value = fileName;
    document.getElementById('parentFolder').value = tempFolderId;
  }

  async function createNewFile() {
    const fileName = document.getElementById('fileName').value.trim();
    const parentFolderId = document.getElementById('parentFolder').value || null;

    if (!fileName) {
      alert('è¯·è¾“å…¥æ–‡ä»¶å');
      return;
    }

    // å¦‚æœæœ‰æœªä¿å­˜çš„å†…å®¹ï¼Œå…ˆä¿å­˜
    if (currentFileId && saveStatus === 'unsaved') {
      if (confirm('å½“å‰æ–‡æ¡£æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ')) {
        await saveCurrentFile();
      }
    }

    // è§£é”ç¼–è¾‘å™¨
    unlockEditor();

    // åˆ›å»ºæ–°æ–‡ä»¶
    const file = {
      id: fileManager.generateId(),
      name: fileName.endsWith('.md') ? fileName : fileName + '.md',
      type: 'file',
      parentId: parentFolderId,
      content: '',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    await fileManager.saveFile(file);

    // è®¾ç½®ä¸ºå½“å‰æ–‡ä»¶
    editor.value = '';
    currentFileId = file.id;
    currentFileName = file.name;
    saveStatus = 'saved';

    updatePreview();
    updateLineNumbers();
    updateStatusBar();
    updateFileInfo();
    updateSaveStatus();
    updateToolbarState();
    loadFileTree();

    editor.focus();
    closeNewFileModal();
    showNotification(`ğŸ“ æ–‡æ¡£ "${file.name}" åˆ›å»ºæˆåŠŸï¼`, 'success');
  }

  // æœç´¢åŠŸèƒ½
  function openSearchModal() {
    document.getElementById('searchModal').style.display = 'block';
    document.getElementById('searchInput').focus();
  }

  function closeSearchModal() {
    document.getElementById('searchModal').style.display = 'none';
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').innerHTML = '';
  }

  async function performSearch() {
    const query = document.getElementById('searchInput').value.trim().toLowerCase();
    const resultsContainer = document.getElementById('searchResults');

    if (!query) {
      resultsContainer.innerHTML = '';
      return;
    }

    const files = await fileManager.getFiles();
    const results = files.filter(file => {
      if (file.type !== 'file') return false;

      const nameMatch = file.name.toLowerCase().includes(query);
      const contentMatch = file.content && file.content.toLowerCase().includes(query);

      return nameMatch || contentMatch;
    });

    if (results.length === 0) {
      resultsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶</div>';
      return;
    }

    resultsContainer.innerHTML = results.map(file => {
      const folderPath = getFolderPath(file.parentId, files);
      const preview = file.content ? file.content.substring(0, 100) + (file.content.length > 100 ? '...' : '') : 'ç©ºæ–‡ä»¶';

      return `
                    <div class="search-result-item" onclick="openSearchResult('${file.id}')">
                        <div class="search-result-name">${file.name}</div>
                        <div class="search-result-path">${folderPath}</div>
                        <div class="search-result-preview">${preview}</div>
                    </div>
                `;
    }).join('');
  }

  function getFolderPath(parentId, files) {
    if (!parentId) return 'æ ¹ç›®å½•';

    const folder = files.find(f => f.id === parentId);
    if (!folder) return 'æ ¹ç›®å½•';

    const parentPath = getFolderPath(folder.parentId, files);
    return parentPath === 'æ ¹ç›®å½•' ? folder.name : `${parentPath} / ${folder.name}`;
  }

  async function openSearchResult(fileId) {
    const files = await fileManager.getFiles();
    const file = files.find(f => f.id === fileId);

    if (file) {
      await loadFileContent(file);
      closeSearchModal();
    }
  }

  // å¿«é€Ÿæœç´¢åŠŸèƒ½
  async function quickSearchFiles() {
    const query = document.getElementById('quickSearch').value.trim().toLowerCase();

    if (!query) {
      loadFileTree();
      return;
    }

    const files = await fileManager.getFiles();
    const results = files.filter(file => {
      if (file.type !== 'file') return false;
      return file.name.toLowerCase().includes(query);
    });

    // é«˜äº®æœç´¢ç»“æœ
    document.querySelectorAll('.tree-item').forEach(item => {
      item.classList.remove('search-result');
    });

    results.forEach(file => {
      const fileEl = document.querySelector(`[data-file-id="${file.id}"]`);
      if (fileEl) {
        fileEl.classList.add('search-result');
      }
    });
  }

  // ä¿®å¤è¡Œå·å’ŒçŠ¶æ€æ ç®¡ç†
  function updateStatusBar() {
    const text = editor.value;
    const lines = text.split('\n');
    const cursorPos = editor.selectionStart;
    const textBeforeCursor = text.substring(0, cursorPos);
    const linesBeforeCursor = textBeforeCursor.split('\n');

    const currentLine = linesBeforeCursor.length;
    const currentCol = linesBeforeCursor[linesBeforeCursor.length - 1].length + 1;
    const wordCount = text.replace(/\s+/g, ' ').trim().length;

    document.getElementById('currentLine').textContent = currentLine;
    document.getElementById('currentCol').textContent = currentCol;
    document.getElementById('wordCount').textContent = wordCount;

    // é«˜äº®å½“å‰è¡Œå·
    document.querySelectorAll('.line-number').forEach((el, index) => {
      el.classList.toggle('active', index + 1 === currentLine);
    });
  }

  function gotoSpecificLine(lineNumber) {
    const lines = editor.value.split('\n');
    if (lineNumber > lines.length) return;

    let position = 0;
    for (let i = 0; i < lineNumber - 1; i++) {
      position += lines[i].length + 1; // +1 for newline
    }

    editor.focus();
    editor.setSelectionRange(position, position);
    updateStatusBar();
  }

  // è·³è½¬è¡ŒåŠŸèƒ½
  function showGotoLine() {
    if (isEditorLocked) return;
    const gotoLineEl = document.getElementById('gotoLine');
    gotoLineEl.style.display = 'block';
    document.getElementById('gotoLineInput').focus();
  }

  function hideGotoLine() {
    document.getElementById('gotoLine').style.display = 'none';
  }

  function gotoLine() {
    const lineNumber = parseInt(document.getElementById('gotoLineInput').value);
    if (lineNumber && lineNumber > 0) {
      gotoSpecificLine(lineNumber);
      hideGotoLine();
    }
  }

  // æ¸…ç©ºç¼–è¾‘å™¨ç¡®è®¤
  function confirmClearEditor() {
    if (isEditorLocked) return;
    if (confirm('ç¡®å®šè¦æ¸…ç©ºç¼–è¾‘å™¨å†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
      editor.value = '';
      updatePreview();
      updateLineNumbers();
      updateStatusBar();
      markAsUnsaved();
      showNotification('ğŸ—‘ï¸ ç¼–è¾‘å™¨å·²æ¸…ç©º', 'warning');
    }
  }

  // å®æ—¶é¢„è§ˆæ›´æ–°
  function updatePreview() {
    const markdown = editor.value;
    const html = parser.parse(markdown);
    preview.innerHTML = html;
  }

  // ç›‘å¬ç¼–è¾‘å™¨å˜åŒ–
  editor.addEventListener('input', function() {
    if (isEditorLocked) return;

    updatePreview();
    updateLineNumbers();
    updateStatusBar();
    markAsUnsaved();
    createTempFileIfNeeded();

    // å»¶è¿Ÿè‡ªåŠ¨ä¿å­˜
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(autoSave, 5000); // 5ç§’åè‡ªåŠ¨ä¿å­˜
  });

  editor.addEventListener('selectionchange', updateStatusBar);
  editor.addEventListener('keyup', updateStatusBar);
  editor.addEventListener('mouseup', updateStatusBar);

  // æ–‡ä»¶çŠ¶æ€ç®¡ç†
  function markAsUnsaved() {
    if (saveStatus !== 'unsaved' && saveStatus !== 'closed') {
      saveStatus = 'unsaved';
      updateSaveStatus();
      updateToolbarState();
    }
  }

  function markAsSaved() {
    if (saveStatus !== 'saved') {
      saveStatus = 'saved';
      updateSaveStatus();
      updateToolbarState();
    }
  }

  function markAsSaving() {
    saveStatus = 'saving';
    updateSaveStatus();
    updateToolbarState();
  }

  function updateSaveStatus() {
    const indicator = document.getElementById('saveIndicator');
    const text = document.getElementById('saveStatusText');

    indicator.className = `save-indicator ${saveStatus}`;

    switch (saveStatus) {
      case 'saved':
        text.textContent = 'å·²ä¿å­˜';
        break;
      case 'unsaved':
        text.textContent = currentFileId ? 'æœªä¿å­˜' : 'ä¸´æ—¶æ–‡ä»¶';
        break;
      case 'saving':
        text.textContent = 'ä¿å­˜ä¸­...';
        break;
      case 'closed':
        text.textContent = 'å·²å…³é—­';
        break;
    }
  }

  function updateFileInfo() {
    const fileNameEl = document.querySelector('.file-name');
    if (saveStatus === 'closed') {
      fileNameEl.textContent = 'æ— æ–‡ä»¶';
      fileNameEl.className = 'file-name no-file';
    } else {
      fileNameEl.textContent = currentFileName;
      fileNameEl.className = 'file-name';
    }
    fileNameEl.title = currentFileName;
  }

  // è‡ªåŠ¨ä¿å­˜
  async function autoSave() {
    if (currentFileId && saveStatus === 'unsaved') {
      markAsSaving();
      try {
        await saveCurrentFile();
        showNotification('ğŸ’¾ å·²è‡ªåŠ¨ä¿å­˜', 'success', 2000);
      } catch (error) {
        markAsUnsaved();
        showNotification('âŒ è‡ªåŠ¨ä¿å­˜å¤±è´¥', 'warning');
      }
    }
  }

  // ä¸»é¢˜ç®¡ç†
  function setTheme(theme) {
    currentTheme = theme;
    document.body.className = theme === 'light' ? '' : `theme-${theme}`;
    localStorage.setItem('markdown-editor-theme', theme);
    updateThemeButtons();
  }

  function loadTheme() {
    const savedTheme = localStorage.getItem('markdown-editor-theme') || 'light';
    setTheme(savedTheme);
  }

  function updateThemeButtons() {
    document.querySelectorAll('.theme-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelector(`.theme-btn.${currentTheme}`).classList.add('active');
  }

  // å·¥å…·æ åŠŸèƒ½
  function insertMarkdown(before, after = '') {
    if (isEditorLocked) return;

    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const selectedText = editor.value.substring(start, end);
    const newText = before + selectedText + after;

    editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);
    editor.selectionStart = start + before.length;
    editor.selectionEnd = start + before.length + selectedText.length;
    editor.focus();
    updatePreview();
    updateLineNumbers();
    markAsUnsaved();
  }

  function insertQuote() {
    if (isEditorLocked) return;
    insertAtLineStart('> ');
  }

  function insertDivider() {
    if (isEditorLocked) return;
    const divider = '\n\n---\n\n';
    const start = editor.selectionStart;
    editor.value = editor.value.substring(0, start) + divider + editor.value.substring(start);
    editor.selectionStart = start + divider.length;
    editor.focus();
    updatePreview();
    updateLineNumbers();
    markAsUnsaved();
  }

  function insertAtLineStart(prefix) {
    if (isEditorLocked) return;

    const start = editor.selectionStart;
    const lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;

    editor.value = editor.value.substring(0, lineStart) + prefix + editor.value.substring(lineStart);
    editor.selectionStart = start + prefix.length;
    editor.selectionEnd = start + prefix.length;
    editor.focus();
    updatePreview();
    updateLineNumbers();
    markAsUnsaved();
  }

  function insertLink() {
    if (isEditorLocked) return;
    const url = prompt('è¯·è¾“å…¥é“¾æ¥åœ°å€:');
    if (url) {
      const text = prompt('è¯·è¾“å…¥é“¾æ¥æ–‡æœ¬:') || url;
      insertMarkdown(`[${text}](`, `${url})`);
    }
  }

  function insertImage() {
    if (isEditorLocked) return;
    const url = prompt('è¯·è¾“å…¥å›¾ç‰‡åœ°å€:');
    if (url) {
      const alt = prompt('è¯·è¾“å…¥å›¾ç‰‡æè¿°:') || 'å›¾ç‰‡';
      insertMarkdown(`![${alt}](`, `${url})`);
    }
  }

  // è¡¨æ ¼ç¼–è¾‘å™¨
  function openTableEditor() {
    if (isEditorLocked) return;
    document.getElementById('tableModal').style.display = 'block';
    generateTable();
  }

  function closeTableModal() {
    document.getElementById('tableModal').style.display = 'none';
  }

  function generateTable() {
    const rows = parseInt(document.getElementById('tableRows').value);
    const cols = parseInt(document.getElementById('tableCols').value);
    const alternateRows = document.getElementById('alternateRows').checked;
    const tableEditor = document.getElementById('tableEditor');

    let tableHTML = '<table><thead><tr>';

    // è¡¨å¤´
    for (let j = 0; j < cols; j++) {
      tableHTML += `<th><input type="text" placeholder="åˆ—${j + 1}" value="åˆ—${j + 1}"></th>`;
    }
    tableHTML += '</tr></thead><tbody>';

    // è¡¨æ ¼å†…å®¹
    for (let i = 0; i < rows; i++) {
      const rowClass = alternateRows && i % 2 === 1 ? ' style="background: var(--button-bg);"' : '';
      tableHTML += `<tr${rowClass}>`;
      for (let j = 0; j < cols; j++) {
        tableHTML += `<td><input type="text" placeholder="æ•°æ®${i + 1}-${j + 1}"></td>`;
      }
      tableHTML += '</tr>';
    }
    tableHTML += '</tbody></table>';

    tableEditor.innerHTML = tableHTML;
  }

  function addTableRow() {
    const currentRows = parseInt(document.getElementById('tableRows').value);
    document.getElementById('tableRows').value = currentRows + 1;
    generateTable();
  }

  function addTableCol() {
    const currentCols = parseInt(document.getElementById('tableCols').value);
    document.getElementById('tableCols').value = currentCols + 1;
    generateTable();
  }

  function clearTable() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºè¡¨æ ¼å†…å®¹å—ï¼Ÿ')) {
      document.querySelectorAll('#tableEditor input').forEach(input => input.value = '');
    }
  }

  function resetTable() {
    if (confirm('ç¡®å®šè¦é‡ç½®æ•´ä¸ªè¡¨æ ¼å—ï¼Ÿ')) {
      document.getElementById('tableRows').value = 3;
      document.getElementById('tableCols').value = 3;
      generateTable();
    }
  }

  // Excel ç²˜è´´åŠŸèƒ½
  function focusPasteArea() {
    const pasteInput = document.getElementById('pasteInput');
    pasteInput.focus();
    pasteInput.select();
  }

  document.getElementById('pasteInput').addEventListener('paste', function(e) {
    setTimeout(() => {
      const pastedData = e.target.value;
      if (pastedData.trim()) {
        parseExcelData(pastedData);
        e.target.value = '';
      }
    }, 100);
  });

  function parseExcelData(data) {
    const lines = data.split('\n').filter(line => line.trim());
    if (lines.length === 0) return;

    const rows = lines.map(line => line.split('\t'));
    const maxCols = Math.max(...rows.map(row => row.length));

    // è®¾ç½®è¡¨æ ¼å°ºå¯¸
    document.getElementById('tableRows').value = Math.max(1, rows.length - 1);
    document.getElementById('tableCols').value = maxCols;

    // ç”Ÿæˆè¡¨æ ¼
    generateTable();

    // å¡«å……æ•°æ®
    setTimeout(() => {
      const inputs = document.querySelectorAll('#tableEditor input');
      let inputIndex = 0;

      // å¡«å……è¡¨å¤´
      for (let j = 0; j < maxCols; j++) {
        if (inputs[inputIndex]) {
          inputs[inputIndex].value = rows[0][j] || `åˆ—${j + 1}`;
          inputIndex++;
        }
      }

      // å¡«å……æ•°æ®è¡Œ
      for (let i = 1; i < rows.length; i++) {
        for (let j = 0; j < maxCols; j++) {
          if (inputs[inputIndex]) {
            inputs[inputIndex].value = rows[i][j] || '';
            inputIndex++;
          }
        }
      }

      document.getElementById('pasteArea').innerHTML = '<div style="color: var(--success-color);">âœ… å·²æˆåŠŸå¯¼å…¥ Excel æ•°æ®ï¼</div>';
      setTimeout(() => {
        document.getElementById('pasteArea').innerHTML = `
                        <div style="font-size: 16px; margin-bottom: 8px;">ğŸ“‹ Excel æ•°æ®å¯¼å…¥</div>
                        <div>ä» Excel å¤åˆ¶è¡¨æ ¼æ•°æ®ï¼Œç„¶åç‚¹å‡»è¿™é‡Œç²˜è´´</div>
                    `;
      }, 2000);
    }, 100);
  }

  function insertTableFromEditor() {
    const table = document.querySelector('#tableEditor table');
    const headerCells = Array.from(table.querySelectorAll('thead input')).map(input => input.value || 'åˆ—');
    const rows = Array.from(table.querySelectorAll('tbody tr'));

    let markdown = '\n| ' + headerCells.join(' | ') + ' |\n';
    markdown += '|' + headerCells.map(() => '-----').join('|') + '|\n';

    rows.forEach(row => {
      const cells = Array.from(row.querySelectorAll('td input')).map(input => input.value || '');
      markdown += '| ' + cells.join(' | ') + ' |\n';
    });

    markdown += '\n';

    const start = editor.selectionStart;
    editor.value = editor.value.substring(0, start) + markdown + editor.value.substring(start);
    editor.selectionStart = start + markdown.length;
    editor.focus();
    updatePreview();
    updateLineNumbers();
    markAsUnsaved();
    closeTableModal();
    showNotification('ğŸ“Š è¡¨æ ¼æ’å…¥æˆåŠŸï¼', 'success');
  }

  // ä»£ç å—ç¼–è¾‘å™¨
  function openCodeBlock() {
    if (isEditorLocked) return;
    document.getElementById('codeModal').style.display = 'block';
    document.getElementById('codeContent').focus();
  }

  function closeCodeModal() {
    document.getElementById('codeModal').style.display = 'none';
    document.getElementById('codeContent').value = '';
    document.getElementById('codeLanguage').value = '';
  }

  function insertCodeFromModal() {
    const language = document.getElementById('codeLanguage').value;
    const content = document.getElementById('codeContent').value;

    const codeBlock = `\n\`\`\`${language}\n${content}\n\`\`\`\n\n`;

    const start = editor.selectionStart;
    editor.value = editor.value.substring(0, start) + codeBlock + editor.value.substring(start);
    editor.selectionStart = start + codeBlock.length;
    editor.focus();
    updatePreview();
    updateLineNumbers();
    markAsUnsaved();
    closeCodeModal();
    showNotification('ğŸ’» ä»£ç å—æ’å…¥æˆåŠŸï¼', 'success');
  }

  // æ–‡ä»¶ç®¡ç† - ä¿®å¤ç›®å½•æ ‘ç»“æ„
  async function loadFileTree() {
    allFiles = await fileManager.getFiles();
    const tree = document.getElementById('fileTree');
    tree.innerHTML = '';

    // æ„å»ºå±‚çº§ç»“æ„
    buildTreeLevel(tree, null, 0);

    // å¦‚æœæ²¡æœ‰æ–‡ä»¶ï¼Œåˆ›å»ºé»˜è®¤ç»“æ„
    if (allFiles.length === 0) {
      await createDefaultStructure();
      loadFileTree();
    }
  }

  function buildTreeLevel(container, parentId, level) {
    // è·å–å½“å‰å±‚çº§çš„æ–‡ä»¶å¤¹å’Œæ–‡ä»¶
    const folders = allFiles.filter(f => f.type === 'folder' && f.parentId === parentId);
    const files = allFiles.filter(f => f.type === 'file' && f.parentId === parentId);

    // å…ˆæ¸²æŸ“æ–‡ä»¶å¤¹
    folders.forEach(folder => {
      const treeItem = createTreeItem(folder, level, true);
      container.appendChild(treeItem);

      // å¦‚æœæ–‡ä»¶å¤¹å±•å¼€ï¼Œé€’å½’æ¸²æŸ“å­é¡¹
      if (expandedFolders.has(folder.id)) {
        buildTreeLevel(container, folder.id, level + 1);
      }
    });

    // å†æ¸²æŸ“æ–‡ä»¶
    files.forEach(file => {
      const treeItem = createTreeItem(file, level, false);
      container.appendChild(treeItem);
    });
  }

  function createTreeItem(item, level, isFolder) {
    const treeItem = document.createElement('div');
    treeItem.className = 'tree-item';
    treeItem.style.paddingLeft = `${level * 16 + 8}px`;

    if (isFolder) {
      treeItem.setAttribute('data-folder-id', item.id);
    } else {
      treeItem.setAttribute('data-file-id', item.id);
    }

    let content = `<span class="tree-indent" style="width: ${level * 16}px;"></span>`;

    if (isFolder) {
      const hasChildren = allFiles.some(f => f.parentId === item.id);
      const isExpanded = expandedFolders.has(item.id);

      content += `
                    <span class="tree-toggle ${isExpanded ? 'expanded' : ''}"
                          onclick="toggleTreeFolder('${item.id}')"
                          style="visibility: ${hasChildren ? 'visible' : 'hidden'}">
                        â–¶
                    </span>
                    <span class="tree-icon">ğŸ“</span>
                    <span class="tree-label" onclick="selectTreeItem('${item.id}', 'folder')"
                          oncontextmenu="showContextMenu(event, '${item.id}', 'folder')">${item.name}</span>
                `;
    } else {
      content += `
                    <span style="width: 16px; display: inline-block;"></span>
                    <span class="tree-icon">ğŸ“„</span>
                    <span class="tree-label" onclick="loadFileFromTree('${item.id}')"
                          oncontextmenu="showContextMenu(event, '${item.id}', 'file')">${item.name}</span>
                `;

      // é«˜äº®å½“å‰æ–‡ä»¶
      if (item.id === currentFileId) {
        treeItem.classList.add('current');
      }
    }

    treeItem.innerHTML = content;
    return treeItem;
  }

  function toggleTreeFolder(folderId) {
    const isExpanded = expandedFolders.has(folderId);

    if (isExpanded) {
      expandedFolders.delete(folderId);
    } else {
      expandedFolders.add(folderId);
    }

    // é‡æ–°æ¸²æŸ“æ ‘
    loadFileTree();
  }

  function selectTreeItem(itemId, type) {
    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€‰æ‹©é¡¹ç›®çš„é€»è¾‘
  }

  async function loadFileFromTree(fileId) {
    const file = allFiles.find(f => f.id === fileId);
    if (file) {
      await loadFileContent(file);
    }
  }

  // å³é”®èœå•
  function showContextMenu(event, fileId, type) {
    event.preventDefault();
    event.stopPropagation();

    selectedFileForContext = { id: fileId, type: type };

    const contextMenu = document.getElementById('contextMenu');
    contextMenu.style.display = 'block';
    contextMenu.style.left = event.pageX + 'px';
    contextMenu.style.top = event.pageY + 'px';
  }

  function hideContextMenu() {
    document.getElementById('contextMenu').style.display = 'none';
    selectedFileForContext = null;
  }

  // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—èœå•
  document.addEventListener('click', hideContextMenu);

  async function openSelectedFile() {
    if (selectedFileForContext && selectedFileForContext.type === 'file') {
      const file = allFiles.find(f => f.id === selectedFileForContext.id);
      if (file) {
        await loadFileContent(file);
      }
    }
    hideContextMenu();
  }

  async function renameFile() {
    if (!selectedFileForContext) return;

    const file = allFiles.find(f => f.id === selectedFileForContext.id);

    if (file) {
      const newName = prompt('è¯·è¾“å…¥æ–°åç§°:', file.name);
      if (newName && newName !== file.name) {
        file.name = newName;
        file.updatedAt = new Date().toISOString();
        await fileManager.saveFile(file);

        if (file.id === currentFileId) {
          currentFileName = newName;
          updateFileInfo();
        }

        loadFileTree();
        showNotification('âœï¸ é‡å‘½åæˆåŠŸï¼', 'success');
      }
    }
    hideContextMenu();
  }

  // ä¿®å¤ç§»åŠ¨æ–‡ä»¶åŠŸèƒ½
  async function moveFile() {
    if (!selectedFileForContext) return;

    const selectedItem = allFiles.find(f => f.id === selectedFileForContext.id);

    if (!selectedItem) {
        showNotification('âŒ æœªæ‰¾åˆ°é€‰ä¸­çš„é¡¹ç›®', 'warning');
        hideContextMenu();
        return;
    }

    // ä¿å­˜å½“å‰é€‰ä¸­çš„æ–‡ä»¶/æ–‡ä»¶å¤¹ä¿¡æ¯
    const moveItem = {
        id: selectedFileForContext.id,
        type: selectedFileForContext.type,
        name: selectedItem.name
    };

    // è®¾ç½®ç§»åŠ¨é¡¹ç›®åç§°
    document.getElementById('moveItemName').textContent = moveItem.name;

    // æ„å»ºæ–‡ä»¶å¤¹åˆ—è¡¨ï¼ˆæ’é™¤è‡ªå·±ï¼Œå¦‚æœæ˜¯æ–‡ä»¶å¤¹çš„è¯ï¼‰
    const folders = allFiles.filter(f =>
            f.type === 'folder' &&
            f.id !== moveItem.id &&
            !isChildFolder(f.id, moveItem.id, allFiles)
    );

    const folderList = document.getElementById('folderList');
    folderList.innerHTML = `
                <div class="folder-item" onclick="selectFolderForMove(null)" data-folder-id="modal-root">
                    ğŸ“ æ ¹ç›®å½•
                </div>
            `;

    folders.forEach(folder => {
        const folderItem = document.createElement('div');
        folderItem.className = 'folder-item';
        folderItem.setAttribute('data-folder-id', `modal-${folder.id}`);
        folderItem.onclick = () => selectFolderForMove(folder.id);

        const path = getFolderPath(folder.parentId, allFiles);
        const displayPath = path === 'æ ¹ç›®å½•' ? folder.name : `${path} / ${folder.name}`;
        folderItem.innerHTML = `ğŸ“ ${displayPath}`;
        folderList.appendChild(folderItem);
    });

    // å°†é€‰ä¸­é¡¹å­˜å‚¨åœ¨æ¨¡æ€æ¡†çš„æ•°æ®å±æ€§ä¸­
    document.getElementById('moveFileModal').setAttribute('data-moving-item', JSON.stringify(moveItem));

    document.getElementById('moveFileModal').style.display = 'block';
    hideContextMenu();
  }

  // æ£€æŸ¥æ˜¯å¦ä¸ºå­æ–‡ä»¶å¤¹
  function isChildFolder(folderId, parentId, files) {
    const folder = files.find(f => f.id === folderId);
    if (!folder || !folder.parentId) return false;

    if (folder.parentId === parentId) return true;
    return isChildFolder(folder.parentId, parentId, files);
  }

  function selectFolderForMove(folderId) {
    selectedFolderForMove = folderId;

    // é«˜äº®é€‰ä¸­çš„æ–‡ä»¶å¤¹
    document.querySelectorAll('#folderList .folder-item').forEach(item => {
      item.classList.remove('selected');
    });

    // æ‰¾åˆ°å¯¹åº”çš„å…ƒç´ å¹¶é«˜äº®
    const targetElement = document.querySelector(`[data-folder-id="${folderId === null ? 'modal-root' : `modal-${folderId}`}"]`); // ä½¿ç”¨å‰ç¼€åŒ¹é…
    if (targetElement) {
      targetElement.classList.add('selected');
    }
  }

  async function confirmMoveFile() {
    const moveItemStr = document.getElementById('moveFileModal').getAttribute('data-moving-item');
    if (!moveItemStr) {
        showNotification('âŒ æ²¡æœ‰é€‰ä¸­è¦ç§»åŠ¨çš„é¡¹ç›®', 'warning');
        return;
    }

    const moveItem = JSON.parse(moveItemStr);
    if (!moveItem) {
        showNotification('âŒ ç§»åŠ¨é¡¹ç›®æ— æ•ˆ', 'warning');
        return;
    }

    const file = allFiles.find(f => f.id === moveItem.id);

    if (file) {
        const oldParentId = file.parentId;
        file.parentId = selectedFolderForMove; // ç›´æ¥ä½¿ç”¨åŸå§‹ idï¼Œæ— éœ€è½¬æ¢
        file.updatedAt = new Date().toISOString();
        await fileManager.saveFile(file);

        // è·å–ç›®æ ‡æ–‡ä»¶å¤¹åç§°ç”¨äºæç¤º
        let targetFolderName = 'æ ¹ç›®å½•';
        if (selectedFolderForMove) {
            const targetFolder = allFiles.find(f => f.id === selectedFolderForMove);
            if (targetFolder) {
                targetFolderName = targetFolder.name;
            }
        }

        loadFileTree();
        showNotification(`ğŸ“ ${file.name} å·²ç§»åŠ¨åˆ° "${targetFolderName}"ï¼`, 'success');
    } else {
        showNotification('âŒ ç§»åŠ¨å¤±è´¥ï¼Œæœªæ‰¾åˆ°æ–‡ä»¶', 'warning');
    }

    closeMoveFileModal();
  }

  function closeMoveFileModal() {
    document.getElementById('moveFileModal').removeAttribute('data-moving-item');
    document.getElementById('moveFileModal').style.display = 'none';
    selectedFolderForMove = undefined; // é‡ç½®ä¸º undefined
  }

  async function deleteFileConfirm() {
    if (!selectedFileForContext) return;

    const file = allFiles.find(f => f.id === selectedFileForContext.id);

    if (file && confirm(`ç¡®å®šè¦åˆ é™¤ "${file.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
      // å¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œéœ€è¦åˆ é™¤æ‰€æœ‰å­é¡¹
      if (file.type === 'folder') {
        const childItems = getAllChildItems(file.id, allFiles);
        for (const childItem of childItems) {
          await fileManager.deleteFile(childItem.id);
        }
      }

      await fileManager.deleteFile(file.id);

      if (file.id === currentFileId) {
        closeCurrentFile();
      }

      loadFileTree();
      showNotification('ğŸ—‘ï¸ åˆ é™¤æˆåŠŸï¼', 'warning');
    }
    hideContextMenu();
  }

  // è·å–æ‰€æœ‰å­é¡¹
  function getAllChildItems(parentId, files) {
    const children = files.filter(f => f.parentId === parentId);
    let allChildren = [...children];

    children.filter(f => f.type === 'folder').forEach(folder => {
      allChildren = allChildren.concat(getAllChildItems(folder.id, files));
    });

    return allChildren;
  }

  async function createFolder() {
    const name = prompt('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°:');
    if (name) {
      const folder = {
        id: fileManager.generateId(),
        name: name,
        type: 'folder',
        parentId: null,
        createdAt: new Date().toISOString()
      };

      await fileManager.saveFile(folder);
      loadFileTree();
      showNotification('ğŸ“ æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸï¼', 'success');
    }
  }

  async function createDefaultStructure() {
    const defaultFolder = {
      id: fileManager.generateId(),
      name: 'æˆ‘çš„æ–‡æ¡£',
      type: 'folder',
      parentId: null,
      createdAt: new Date().toISOString()
    };

    const tempFolder = {
      id: fileManager.generateId(),
      name: 'ä¸´æ—¶æ–‡ä»¶',
      type: 'folder',
      parentId: null,
      createdAt: new Date().toISOString()
    };

    const welcomeFile = {
      id: fileManager.generateId(),
      name: 'æ¬¢è¿æ–‡æ¡£.md',
      type: 'file',
      parentId: defaultFolder.id,
      content: editor.value,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    await fileManager.saveFile(defaultFolder);
    await fileManager.saveFile(tempFolder);
    await fileManager.saveFile(welcomeFile);

    tempFolderId = tempFolder.id;
  }

  async function loadFileContent(file) {
    // å¦‚æœæœ‰æœªä¿å­˜çš„å†…å®¹ï¼Œå…ˆä¿å­˜
    if (currentFileId && saveStatus === 'unsaved') {
      if (confirm('å½“å‰æ–‡æ¡£æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ')) {
        markAsSaving();
        await saveCurrentFile();
      }
    }

    // è§£é”ç¼–è¾‘å™¨
    unlockEditor();

    // åŠ è½½æ–°æ–‡ä»¶
    editor.value = file.content || '';
    currentFileId = file.id;
    currentFileName = file.name;
    saveStatus = 'saved';

    updatePreview();
    updateLineNumbers();
    updateStatusBar();
    updateFileInfo();
    updateSaveStatus();
    updateToolbarState();

    // æ›´æ–°UI
    loadFileTree();

    showNotification(`ğŸ“– å·²æ‰“å¼€: ${file.name}`, 'info');
  }

  async function saveCurrentFile() {
    if (!currentFileId) return;

    const currentFile = allFiles.find(f => f.id === currentFileId);

    if (currentFile) {
      currentFile.content = editor.value;
      currentFile.updatedAt = new Date().toISOString();
      await fileManager.saveFile(currentFile);
      markAsSaved();
    }
  }

  async function saveFile() {
    if (isEditorLocked) return;

    markAsSaving();

    try {
      if (currentFileId) {
        await saveCurrentFile();
        showNotification('ğŸ’¾ æ–‡ä»¶ä¿å­˜æˆåŠŸï¼', 'success');
      } else {
        const name = prompt('è¯·è¾“å…¥æ–‡ä»¶å:');
        if (name) {
          const file = {
            id: fileManager.generateId(),
            name: name.endsWith('.md') ? name : name + '.md',
            type: 'file',
            parentId: tempFolderId, // é»˜è®¤ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹
            content: editor.value,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };

          await fileManager.saveFile(file);
          currentFileId = file.id;
          currentFileName = file.name;
          markAsSaved();
          updateFileInfo();
          loadFileTree();
          showNotification('ğŸ’¾ æ–‡ä»¶åˆ›å»ºå¹¶ä¿å­˜æˆåŠŸï¼', 'success');
        } else {
          markAsUnsaved();
        }
      }
    } catch (error) {
      markAsUnsaved();
      showNotification('âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'warning');
    }
  }

  async function exportData() {
    const files = await fileManager.getFiles();
    const dataStr = JSON.stringify(files, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `markdown-editor-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification('ğŸ“¤ æ•°æ®å¯¼å‡ºæˆåŠŸï¼', 'success');
  }

  function importData() {
    document.getElementById('importInput').click();
  }

  async function handleImport(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = JSON.parse(e.target.result);

          if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–ç°æœ‰æ–‡ä»¶ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
            // æ¸…ç©ºç°æœ‰æ•°æ®
            const existingFiles = await fileManager.getFiles();
            for (const file of existingFiles) {
              await fileManager.deleteFile(file.id);
            }

            // å¯¼å…¥æ–°æ•°æ®
            for (const file of data) {
              await fileManager.saveFile(file);
            }

            // é‡æ–°åˆå§‹åŒ–
            await ensureTempFolder();
            closeCurrentFile();

            loadFileTree();
            showNotification('ğŸ“¥ æ•°æ®å¯¼å…¥æˆåŠŸï¼', 'success');
          }
        } catch (error) {
          showNotification('âŒ å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'warning');
        }
      };
      reader.readAsText(file);
    }
  }

  // æ–‡ä»¶æ“ä½œ
  function loadFile(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        // è§£é”ç¼–è¾‘å™¨
        unlockEditor();

        editor.value = e.target.result;

        // é‡ç½®ä¸ºä¸´æ—¶æ–‡ä»¶çŠ¶æ€
        markAsTempFile();

        updatePreview();
        updateLineNumbers();
        updateStatusBar();
        showNotification(`ğŸ“ æ–‡ä»¶ "${file.name}" åŠ è½½æˆåŠŸï¼`, 'success');
      };
      reader.readAsText(file);
    }
  }

  // åˆ‡æ¢é¢æ¿
  function togglePreview() {
    previewVisible = !previewVisible;
    if (previewVisible) {
      previewSection.classList.remove('hidden');
      togglePreviewButton.innerHTML = 'ğŸ‘ï¸ é¢„è§ˆ';
      togglePreviewButton.classList.remove('active');
    } else {
      previewSection.classList.add('hidden');
      togglePreviewButton.innerHTML = 'ğŸ‘ï¸ æ˜¾ç¤ºé¢„è§ˆ';
      togglePreviewButton.classList.add('active');
    }
  }

  function toggleFilePanel() {
    filePanelVisible = !filePanelVisible;
    if (filePanelVisible) {
      filePanel.classList.remove('hidden');
      toggleFilePanelButton.innerHTML = 'ğŸ“‚ æ–‡ä»¶';
      toggleFilePanelButton.classList.remove('active');
    } else {
      filePanel.classList.add('hidden');
      toggleFilePanelButton.innerHTML = 'ğŸ“‚ æ˜¾ç¤ºæ–‡ä»¶';
      toggleFilePanelButton.classList.add('active');
    }
  }

  // é”®ç›˜å¿«æ·é”®
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
      switch(e.key) {
        case 'n':
          e.preventDefault();
          openNewFileModal();
          break;
        case 'f':
          if (e.shiftKey) {
            e.preventDefault();
            openSearchModal();
          }
          break;
        case 'b':
          if (!isEditorLocked) {
            e.preventDefault();
            insertMarkdown('**', '**');
          }
          break;
        case 'i':
          if (!isEditorLocked) {
            e.preventDefault();
            insertMarkdown('*', '*');
          }
          break;
        case 's':
          e.preventDefault();
          saveFile();
          break;
        case 'g':
          e.preventDefault();
          showGotoLine();
          break;
      }
    }

    if (e.ctrlKey && e.altKey && e.key === 'c') {
      e.preventDefault();
      confirmClearEditor();
    }

    // è·³è½¬è¡ŒåŠŸèƒ½ä¸­çš„å›è½¦é”®
    if (e.key === 'Enter' && document.getElementById('gotoLine').style.display === 'block') {
      e.preventDefault();
      gotoLine();
    }

    // Esc é”®éšè—è·³è½¬è¡Œå’Œæœç´¢
    if (e.key === 'Escape') {
      hideGotoLine();
      hideContextMenu();
      closeSearchModal();
      closeNewFileModal();
    }
  });

  editor.addEventListener('keydown', function(e) {
    if (isEditorLocked) return;

    // Tab é”®å¤„ç†
    if (e.key === 'Tab') {
      e.preventDefault();
      const start = editor.selectionStart;
      const end = editor.selectionEnd;
      editor.value = editor.value.substring(0, start) + '    ' + editor.value.substring(end);
      editor.selectionStart = editor.selectionEnd = start + 4;
      updateLineNumbers();
      markAsUnsaved();
    }
  });

  // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
  window.onclick = function(event) {
    const tableModal = document.getElementById('tableModal');
    const codeModal = document.getElementById('codeModal');
    const moveFileModal = document.getElementById('moveFileModal');
    const newFileModal = document.getElementById('newFileModal');
    const searchModal = document.getElementById('searchModal');

    if (event.target === tableModal) {
      closeTableModal();
    }
    if (event.target === codeModal) {
      closeCodeModal();
    }
    if (event.target === moveFileModal) {
      closeMoveFileModal();
    }
    if (event.target === newFileModal) {
      closeNewFileModal();
    }
    if (event.target === searchModal) {
      closeSearchModal();
    }
  }

  // é¡µé¢å…³é—­å‰æé†’ä¿å­˜
  window.addEventListener('beforeunload', function(e) {
    if (saveStatus === 'unsaved') {
      e.preventDefault();
      e.returnValue = 'æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
      return e.returnValue;
    }
  });
</script>
</body>
</html>